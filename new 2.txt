import os
import re
import aspose.pdf as ap
import pandas as pd
from openpyxl import load_workbook

# === CONFIGURATION ===
pdf_folder = r"C:\Users\TAQ7353\UTR\LOB_ActivitySummary_FillingRate\test"  # üìÅ your folder
converted_folder = os.path.join(pdf_folder, "converted_excels")
output_summary = os.path.join(pdf_folder, "activity_summary_results.xlsx")

os.makedirs(converted_folder, exist_ok=True)

# === STEP 1: Convert PDF ‚Üí Excel ===
def convert_pdf_to_excel(pdf_path, excel_path):
    try:
        doc = ap.Document(pdf_path)
        doc.save(excel_path, ap.SaveFormat.Excel)
        return True
    except Exception as e:
        print(f"‚ùå Failed to convert {os.path.basename(pdf_path)}: {e}")
        return False


# === STEP 2: Extract "Summary of Activity" note from Excel ===
def extract_summary_from_excel(excel_path):
    try:
        wb = load_workbook(excel_path, data_only=True)
        ws = wb.active

        # Loop through cells to find the one containing "Summary of Activity"
        for row in ws.iter_rows():
            for cell in row:
                val = str(cell.value).strip() if cell.value else ""
                if re.search(r"\bsummary\s+of\s+activity\b", val, re.IGNORECASE):
                    # Get the cell directly below this one
                    below_row = cell.row + 1
                    below_val = ws.cell(row=below_row, column=cell.column).value

                    # If the next cell is empty, try merged regions or a few rows below
                    if not below_val:
                        for offset in range(2, 6):
                            next_val = ws.cell(row=below_row + offset, column=cell.column).value
                            if next_val:
                                below_val = next_val
                                break

                    if below_val:
                        return str(below_val).strip()

        return "Not found"

    except Exception as e:
        return f"Error reading Excel: {e}"


# === STEP 3: Process all PDFs ===
results = []

for file in os.listdir(pdf_folder):
    if not file.lower().endswith(".pdf"):
        continue

    pdf_path = os.path.join(pdf_folder, file)
    excel_output = os.path.join(converted_folder, file.replace(".pdf", ".xlsx"))

    print(f"üìÑ Processing: {file}")

    # Step 1: Convert
    if convert_pdf_to_excel(pdf_path, excel_output):
        print(f"   ‚úÖ Converted to Excel: {excel_output}")
        # Step 2: Extract summary note
        summary = extract_summary_from_excel(excel_output)
    else:
        summary = "Conversion failed"

    results.append({"PDF_File_Name": file, "Activity_Summary": summary})

# === STEP 4: Save results summary ===
df = pd.DataFrame(results)
df.to_excel(output_summary, index=False)

print(f"\n‚úÖ Extraction complete! Results saved to:\n{output_summary}")
