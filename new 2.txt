import os
import pandas as pd
import tabula
from openpyxl import load_workbook

# === CONFIGURATION ===
pdf_folder = r"D:\Path\To\Your\PDFs"   # ðŸ”¸ Update to your folder path
converted_folder = r"D:\Path\To\ConvertedExcels"
output_file = "activity_summary_results.xlsx"

os.makedirs(converted_folder, exist_ok=True)

results = []

for file in os.listdir(pdf_folder):
    if not file.lower().endswith(".pdf"):
        continue

    pdf_path = os.path.join(pdf_folder, file)
    print(f"Processing: {file}")

    # Step 1 â€” Convert PDF (generated by Excel) back to Excel
    excel_output = os.path.join(converted_folder, file.replace(".pdf", ".xlsx"))
    try:
        tabula.convert_into(pdf_path, excel_output, output_format="xlsx", pages="all")
        print(f"  âœ… Converted to Excel: {excel_output}")

        # Step 2 â€” Read converted Excel and extract merged cells (C39:I41)
        wb = load_workbook(excel_output, data_only=True)
        ws = wb.active

        text_values = []
        for row in ws.iter_rows(min_row=39, max_row=41, min_col=3, max_col=9):
            for cell in row:
                if cell.value:
                    text_values.append(str(cell.value))

        summary = " ".join(text_values).strip() if text_values else "Not found"

    except Exception as e:
        summary = f"Error: {e}"

    results.append({
        "PDF_File_Name": file,
        "Activity_Summary": summary
    })

# Step 3 â€” Save all results
df = pd.DataFrame(results)
df.to_excel(output_file, index=False)
print(f"\nâœ… Extraction complete! Results saved to {output_file}")

