-- Simulate a SAR (Suspicious Activity Report) table
WITH sar_list AS (
  SELECT
    r.case_id,
    r.report_id,
    r.efile_date,
    
    -- Derive filing type using CASE
    CASE 
      WHEN r.filing_type = 1 AND COALESCE(r.cont_activity, 'N') = 'N' THEN 'INITIAL REPORT'
      WHEN r.filing_type = 1 AND COALESCE(r.cont_activity, 'N') = 'Y' THEN 'AMENDMENT'
      ELSE 'OTHER'
    END AS filing_type,
    
    -- Use COALESCE to avoid nulls
    COALESCE(r.total_amount, 0) AS total_amount,
    
    -- Flag if case title starts with 'UTR'
    CASE 
      WHEN UPPER(c.title) LIKE 'UTR%' THEN 1 
      ELSE 0 
    END AS flag_utr,
    
    -- Window function: give row numbers ordered by most recent report
    ROW_NUMBER() OVER (PARTITION BY r.case_id ORDER BY r.report_id DESC) AS row_rank

  FROM reports r
  JOIN cases c ON r.case_id = c.case_id
  
  -- Only include filed reports
  WHERE UPPER(r.status) IN ('FILED', 'ACCEPTED')
)

-- Use the filtered list to get only the latest report per case
SELECT *
FROM sar_list
WHERE row_rank = 1;


