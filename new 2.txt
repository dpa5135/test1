import os
import pandas as pd
import tabula
from openpyxl import load_workbook

# === CONFIGURATION ===
pdf_folder = r"D:\Path\To\Your\PDFs"   # ðŸ”¸ Update this to your folder
converted_folder = r"D:\Path\To\ConvertedExcels"
output_file = "activity_summary_results.xlsx"

os.makedirs(converted_folder, exist_ok=True)

results = []

for file in os.listdir(pdf_folder):
    if not file.lower().endswith(".pdf"):
        continue

    pdf_path = os.path.join(pdf_folder, file)
    print(f"Processing: {file}")

    csv_output = os.path.join(converted_folder, file.replace(".pdf", ".csv"))
    excel_output = os.path.join(converted_folder, file.replace(".pdf", ".xlsx"))

    try:
        # Step 1 â€” Convert PDF to CSV (Tabula supports this)
        tabula.convert_into(pdf_path, csv_output, output_format="csv", pages="all")
        print(f"  âœ… Converted to CSV: {csv_output}")

        # Step 2 â€” Convert CSV â†’ Excel
        df_csv = pd.read_csv(csv_output)
        df_csv.to_excel(excel_output, index=False)

        # Step 3 â€” Extract values from C39:I41 range
        wb = load_workbook(excel_output, data_only=True)
        ws = wb.active

        text_values = []
        for row in ws.iter_rows(min_row=39, max_row=41, min_col=3, max_col=9):
            for cell in row:
                if cell.value:
                    text_values.append(str(cell.value))

        summary = " ".join(text_values).strip() if text_values else "Not found"

    except Exception as e:
        summary = f"Error: {e}"

    results.append({
        "PDF_File_Name": file,
        "Activity_Summary": summary
    })

# === Step 4 â€” Save results ===
df = pd.DataFrame(results)
df.to_excel(output_file, index=False)
print(f"\nâœ… Extraction complete! Results saved to {output_file}")
