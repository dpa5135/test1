import os
import camelot
import pandas as pd

# === CONFIGURATION ===
pdf_folder = r"C:\Users\TAQ7353\UTR\LOB_ActivitySummary_FillingRate\test"
output_excel = os.path.join(pdf_folder, "SummaryOfActivity_Results.xlsx")

# === HELPER FUNCTION ===
def extract_summary_from_pdf(pdf_path):
    try:
        tables = camelot.read_pdf(pdf_path, pages="all")
    except Exception as e:
        print(f"‚ö†Ô∏è Error reading {os.path.basename(pdf_path)}: {e}")
        return None

    for table in tables:
        df = table.df
        for col in df.columns:
            for cell in df[col]:
                if isinstance(cell, str) and "Summary of Activity" in cell:
                    # Split into lines and remove empty ones
                    lines = [line.strip() for line in cell.split("\n") if line.strip()]

                    # Find start and end indexes
                    start_idx = next((i for i, line in enumerate(lines) if "Summary of Activity" in line), None)
                    end_idx = next((i for i, line in enumerate(lines) if "ATTACH FILE" in line), None)

                    # Extract lines between the two markers (exclude both)
                    if start_idx is not None:
                        start_idx += 1  # start *after* Summary of Activity
                        if end_idx is None:
                            extracted = lines[start_idx:]
                        else:
                            extracted = lines[start_idx:end_idx]
                        if extracted:
                            return " ".join(extracted)
    return None


# === MAIN LOOP: iterate through all PDFs in folder ===
results = []

for file_name in os.listdir(pdf_folder):
    if file_name.lower().endswith(".pdf"):
        pdf_path = os.path.join(pdf_folder, file_name)
        print(f"üîç Processing: {file_name}")

        extracted_value = extract_summary_from_pdf(pdf_path)

        if extracted_value:
            print(f"‚úÖ Extracted: {extracted_value}")
        else:
            print(f"‚ö†Ô∏è 'Summary of Activity' not found or no content before 'ATTACH FILE' in {file_name}")

        results.append({
            "PDF_File": file_name,
            "Summary_of_Activity": extracted_value if extracted_value else "Not found"
        })

# === SAVE FINAL RESULTS TO EXCEL ===
df_results = pd.DataFrame(results)
df_results.to_excel(output_excel, index=False)

print("\nüéØ Extraction complete!")
print(f"üíæ Results saved to: {output_excel}")
