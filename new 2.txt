import os
import pandas as pd
import re

# === CONFIGURATION ===
csv_folder = r"D:\Path\To\ConvertedCSVs"   # Folder containing CSVs converted from PDFs
output_file = "activity_summary_from_csvs.xlsx"

results = []

# === FUNCTION: Extract summary text ===
def extract_summary_from_csv(csv_path):
    try:
        # Read CSV, ignore bad lines if structure isn't perfect
        df = pd.read_csv(csv_path, header=None, dtype=str, on_bad_lines="skip").fillna("")

        # Flatten everything into a list of strings (row by row)
        flat_values = [str(cell).strip() for row in df.values for cell in row if str(cell).strip() != ""]

        # Search for the label and take next non-empty line as the summary
        for i, val in enumerate(flat_values):
            if re.search(r"\bsummary\s+of\s+activity\b", val, flags=re.IGNORECASE):
                # Get next non-empty string (if any)
                for j in range(i + 1, len(flat_values)):
                    nxt = flat_values[j].strip()
                    if nxt:
                        return nxt
        return "Not found"

    except Exception as e:
        return f"Error: {e}"

# === MAIN LOOP ===
for file in os.listdir(csv_folder):
    if not file.lower().endswith(".csv"):
        continue

    csv_path = os.path.join(csv_folder, file)
    print(f"Processing: {file}")
    summary = extract_summary_from_csv(csv_path)
    results.append({
        "CSV_File_Name": file,
        "Activity_Summary": summary
    })

# === SAVE RESULTS ===
df = pd.DataFrame(results)
df.to_excel(output_file, index=False)
print(f"\nâœ… Extraction complete! Results saved to {output_file}")
